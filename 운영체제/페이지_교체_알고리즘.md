> 선경

### 스왑 공간
메모리 가상화를 통해 우리는 각 프로세스마다 충분히 넓고 독립된 주소 공간이 있는 것처럼 보이게 할 수 있다고 배웠다. 실제로 우리는 메모리 가상화를 통해 남은 메모리보다 크기가 큰 프로그램을 (심지어 여러 개!) 실행할 수 있다. 물리 메모리는 한정되어 있는데 어떻게?!?!?

여기서 **하드 디스크 드라이브**가 등장한다. 운영체제는 나만의 큰 주소 공간이라는 환상을 제공하기 위해 지금 당장 프로그램에서 필요한 부분만을 메모리에 탑재하고, 나머지는 메모리보다는 크지만 속도가 느린 디스크에 보관한다.

즉, 운영체제는 디스크에 페이지들을 저장할 수 있는 **스왑 공간**을 확보하고, 필요에 따라 메모리 페이지를 읽어서 이곳에 쓰거나(swap out), 여기서 페이지를 읽어 메모리에 탑재(swap in)함으로써 가상화를 달성한다.

그렇다면 스왑은 언제 일어날까? 물리 메모리에 존재하지 않는 페이지를 접근하는 행위를 **페이지 폴트**라고 하는데, 페이지 폴트가 발생하면 이를 처리하기 위해 운영체제로 제어권이 넘어가고 **페이지 폴트 핸들러**가 실행되어 필요 시 해당 페이지를 스왑해 온다. 좀 더 자세히 설명하면, 참조하려는 가상 주소가 [TLB](https://github.com/k1ngbon/improved-broccoli/blob/main/운영체제/페이징_세그먼테이션.md)에 없어서 TLB 미스가 발생했는데, 페이지 테이블을 통해 확인했을 때 물리 메모리에도 해당 페이지에 존재하지 않는 경우...이제 더 이상 물러날 곳이 없으므로 디스크에 가서 해당 페이지를 읽어와야 한다. 

<br>

### 페이지 교체 정책
만약 스왑 공간으로부터 페이지를 가져오기 위한 여유 메모리가 부족한 경우에는 어떻게 될까? 새로운 페이지를 위한 공간을 확보하기 위해 하나 혹은 그 이상의 페이지들을 내보내야 한다. 이때 어떤 페이지(들)를 새로운 페이지와 교체할 지 선택하는 것을 **페이지 교체 정책**이라고 한다. 

페이지 교체 정책의 목표는 디스크로부터 페이지를 가져오는 횟수를 최소로 만드는 것이다. 다시 말하면 접근된 페이지가 메모리에 이미 존재하는 횟수를 최대로 만들고자 한다. **최적 교체 정책은 가장 나중에 접근될 페이지를 교체하는 것**이다. 물론 어떤 페이지를 제일 늦게 접근하게 될 지 미리 알 수 없으므로 다른 대안을 찾아봐야 한다. 이제 몇 가지 방식을 알아보자.

- **FIFO(First In First Out)**: 가장 먼저 시스템에 들어온 페이지를 내보낸다.
- **무작위 선택**: 아무 페이지나 랜덤으로 선택해서 내보낸다. 
- **LRU(Least-Recently-Used)**: 가장 오래 전에 사용했던 페이지를 교체한다. 
- **LFU(Least-Frequently-Used)**: 가장 적은 빈도로 사용한 페이지를 교체한다. 


LRU는 과거 정보를 기반으로 하기 때문에 보통 FIFO나 무작위 선택에 비해 성능이 좋으나 과거 이력을 계속 기록해야 하는 등 비용이 비싸다. **시계 알고리즘**과 **갱신된 페이지(Dirty Page)** 를 고려하는 두 가지 개선 사항을 추가하면 LRU에 가까운 정책을 구현할 수 있다. 
- 시계 알고리즘: 시스템의 모든 페이지들이 환형 리스트를 구성한다고 가정할 때, 시계 바늘이 가리키고 있는 페이지의 use bit가 1이라면 최근에 사용되었으므로 use bit을 0으로 바꾸고 건너뛴다. use bit이 0인 페이지를 찾을 때까지 해당 작업을 반복한다. 
- 어떤 페이지가 갱신되었다면 해당 페이지를 내보내기 위해서는 디스크에 변경 내용을 기록해야 하므로 비용이 비싸다. 따라서 변경되지 않은 깨끗한 페이지를 우선적으로 내보낸다. 

> 만약 메모리 사용 요구가 계속 물리 메모리 크기를 초과하는 경우 운영체제는 어떻게 할까? 이런 경우 시스템은 끊임없이 페이지를 교체하게 되는 데 이를 **쓰래싱(thrashing)** 이라고 한다. 일부 버전의 리눅스는 메모리 요구가 초과되면 메모리 부족 킬러를 실행시킨다...Xcode 쓰다 보면 자주 만나는 바로 그 친구..물론 저만 그럴수도...

아무튼 가장 중요한 것은 개별 프로세스는 스왑이나 페이지 교체와 같은 일련의 과정이 일어나는 지 모른다는 사실이다! 그냥 자신만의 크고 연속적인 주소 공간에 접근한다고 생각할 뿐이다....! 

그리고 페이지 교체 정책에 대해 열심히 배웠지만 웃긴 사실은 갈수록 메모리 접근 시간과 디스크 접근 시간의 격차가 커지고 있으므로 그냥 메모리 큰 기기 사는 게 이득이라고 한다...템빨 필승이다 이거에요...16기가 샀어야...ㅠ 